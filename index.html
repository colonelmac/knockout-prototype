<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <title>Courses - Autograder</title>     
    <link rel="stylesheet" type="text/css" href="public/stylesheets/style.css" />
    <link href='http://fonts.googleapis.com/css?family=Droid+Serif|Droid+Sans' rel='stylesheet' type='text/css'>
    
    <meta name="HandheldFriendly" content="true" />
    <meta name="viewport" content="width=device-width,initial-scale:1, maximum-scale=1, user-scalable=0" />
    <meta charset="utf-8" />
    
    <link rel="shortcut icon" type="image/png" href="/public/images/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <link rel="stylesheet" type="text/css" href="queue.css" />
    
    <script type="text/javascript" language="javascript"  src="/public/javascripts/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" language="javascript"  src="/public/javascripts/knockout-2.1.0.js"></script>
    <script type="text/javascript" language="javascript"  src="/public/javascripts/sammy/sammy-0.7.1.min.js"></script>
</head>
<body>

<div id="header">
    <div id="masthead">
        <div id="logo"><a href="/"><span></span></a></div>
        <div id="autograder"><a href="/"><strong>auto</strong>grader</div></a>
        <div id="status">
            <a href="/mobile/feedback" id="feedback"><span></span>Feedback</a>
            <a href="/admin" id="manage"><span></span>Manage</a>
            <a href="/settings/instructor" id="settings"><span></span>Settings</a>
            <a href="/logout" id="logout"><span></span>Logout</a>
        </div>
    </div>
</div>
    
<ul class="horizontal-list">
    <li><a href="/">Courses</a></li>
</ul>
    
<div id="page-wrapper">
    <div id="cards" class="cards" data-bind="foreach: cards">
		<div class="card">
			<div class="card-part card-header">
				<span class="card-header-icon"></span>
				<span class="card-header-name" data-bind="text: name"></span>
			</div>
			<div class="card-part card-separator">
				<span class="title">TUTORS</span>
				<span class="card-button"><a data-bind="click: $parent.joinRoom">JOIN</a></span>
			</div>
			<div class="card-part card-tutors">
				<ul data-bind="foreach: tutors">
					<li><span></span><span data-bind="text: name"></span></li>
				</ul>
			</div>
			<div class="card-part card-separator">
				<span>QUEUE STATS</span>
			</div>

			<div class="card-part card-body">
				Status go here ;)
			</div>

			<div class="card-part card-footer">
				Expected close at 11:00PM
			</div>
		</div>
    </div>
    
    <div id="queue" style="display: none"> <!-- data-bind="with: queueViewModel" -->
        <div id="sidebar">
		    <div class="sidebar-content">
			    <div class="sidebar-part sidebar-header">
				    <span class="sidebar-header-icon"></span>
				    <span class="sidebar-header-name">CSE 110</span>
			    </div>

			    <div class="sidebar-part sidebar-separator">
				    <span class="title">TUTORS</span>
			    </div>

			    <div class="sidebar-part sidebar-list sidebar-tutors">
				    <ul data-bind="foreach: tutors">
					    <li><span></span><span data-bind="text: name"></span></li>
				    </ul>
			    </div>

			    <div class="sidebar-part sidebar-separator">
				    <span class="title">QUEUE</span>
			    </div>

			    <div class="sidebar-list sidebar-queue">
				    <ul data-bind="foreach: messages">
					    <li data-bind="click: $parent.selectMessage">
						    <span class="sidebar-queue-item title" data-bind="text: student().name"></span>
						    <span class="sidebar-queue-item info" data-bind="text: description"></span>
					    </li>
				    </ul>	
			    </div>

		    </div>
	    </div>

	    <div id="main-content">
		    <div class="section">
			    <div class="section-header">
				    <button class="hide-button">Hide</button>
				    <span class="section-header-title">Statistics</span>
			    </div>

			    <div id="chart-container" style="min-width: 200px; height: 200px; margin: 0 auto"></div>
		    </div>

		    <div class="section" data-bind="with: selectedMessage">
			    <div class="section-header">
				    <button class="hide-button">Hide</button>
				    <span class="section-header-title">Current Ticket</span>
			    </div>
			    <div class="section-info">
				    <p data-bind="text: student().name"></p>
				    <p><!-- we should data bind some meta data here --></p> 
			    </div>
			    <div class="section-content">
				    <p data-bind="text: description"></p>
			    </div>
			    <div class="section-actions">
				    <button>Accept</button>
				    <button>Defer</button>
			    </div>
		    </div>
	    </div> 
    </div>
</div>

<div id = "footer"></div>

<script>

    $(document).ready(function () {
    
        /*
         * CardModel - used to model the data represented on a card
         *
         * Dependencies:
         *  TutorModel
         */

        var CardModel = function (n, t, s) {
            var self = this;

            self.name        = ko.observable(n);
            self.tutors      = ko.observableArray(t);
            self.stats       = ko.observableArray(s);

            self.time        = ko.observable();
            self.isClosed    = ko.observable();
            self.close       = function (expected) { };
        };

        /*
         * TutorModel - used to model the data represented on a tutor status
         */

        var TutorModel = function (n, s) {
            var self = this;

            self.name   = n;
            self.status = ko.observable(s); 
        };

        /*
         * StudentModel
         */
       
        var StudentModel = function (n, s) {
            var self = this; 
            
            self.name = n;
            self.status = ko.observable(s);    
        };

        /*
         * MessageModel
         *
         * 
         */

        var MessageModel = function(s, t, d) {
            var self = this

            self.student = ko.observable(s);
            self.tutor = ko.observable(t);
            self.description = d;
            self.submited = new Date();
            self.answered = ko.observable();
        };

        /*
         * CardViewModel 
         * 
         * Dependencies:
         *  CardModel,
         *  TutorModel
         */

        var CardViewModel = function () {
            var self  = this,
                savedCards = null;

            self.cards = ko.observableArray();  

            self.joinRoom = function (card) {                
                saveCards();
                self.cards(null);

                $('#queue').show();

                queueViewModel.resizeSidebar();
                queueViewModel.bindShowHideButtons();
                queueViewModel.tutors(card.tutors());
                queueViewModel.messages([
                    new MessageModel(new StudentModel('Derrick McMillen', 'waiting'), card.tutors()[0], 'I fucked up bad...'),
                    new MessageModel(new StudentModel('Chase Murphy', 'waiting'), card.tutors()[0], 'My linked list is unlinked')
                ]);
            }

            function saveCards () {
                savedCards = self.cards();
            }
        };

        /*
         * Queue View Model
         * 
         * Depends on 
         */

        var QueueViewModel = function() {
            var self = this,
                savedMessages = null;

                /* FIELDS */

                self.tutors = ko.observableArray();
                self.selectedTutor = ko.observable();

                self.messages = ko.observableArray([]);
                self.selectedMessage = ko.observable();

                self.opened = ko.observable();
                self.closed = ko.observable();

                /* METHODS */

                self.selectMessage = function (message) {
                    self.selectedMessage(message);
                    self.bindShowHideButtons();
                };

                self.resizeSidebar = function () {
                    var parts = document.querySelectorAll('.sidebar-part'), 
                        queue = document.querySelector('.sidebar-queue'),
                        horizonalList = document.querySelector('.horizontal-list'),
                        header = document.querySelector('#header'), 
                        height = 0;

                    for (var i = 0; i < parts.length; i++) {
                        var p = parts[i];
                        height += p.scrollHeight;
                    }

                    height += horizonalList.scrollHeight;
                    height += header.scrollHeight; 

                    var tmp = (window.innerHeight - height)
                    queue.style.height = tmp + 'px';
                };

                self.bindShowHideButtons = function () {
                    $('.hide-button').unbind('click');
                    $('.hide-button').click(function (e) {
                        var $this = $(this);

                        if ($this.text() === 'Hide') {
                            $this.parent().siblings().hide();
                            $this.text('Show');
                        }
                        else {
                            $this.parent().siblings().show();
                            $this.text('Hide');
                        }
                    });
                };
        };

        var AppViewModel = function () {
            var self = this;

            self.cardViewModel = new CardViewModel();
            self.queueViewModel = new QueueViewModel();
            
            ko.applyBindings(self.cardViewModel, document.getElementById('cards'));
            ko.applyBindings(self.queueViewModel, document.getElementById('queue')); 
        
            Sammy(function () {
                this.get('#courses', function () {
                    cardViewModel.cards([
                        new CardModel('CSE 80', [new TutorModel('Herp Derpington', 'Busy')], []), 
                        new CardModel('CSE 132A', [new TutorModel('Vinay V.', 'Available')], [])
                    ]);
                });

                this.get('', function () { this.app.runRoute('#courses'); });
            });
        };

        var app = new AppViewModel();
    });

</script>
    
</body>
</html>