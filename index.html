<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <title>Courses - Autograder</title>     
    <link rel="stylesheet" type="text/css" href="public/stylesheets/style.css" />
    <link href='http://fonts.googleapis.com/css?family=Droid+Serif|Droid+Sans' rel='stylesheet' type='text/css'>
    
    <meta name="HandheldFriendly" content="true" />
    <meta name="viewport" content="width=device-width,initial-scale:1, maximum-scale=1, user-scalable=0" />
    <meta charset="utf-8" />
    
    <link rel="shortcut icon" type="image/png" href="/public/images/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <link rel="stylesheet" type="text/css" href="queue.css" />
    
    <script type="text/javascript" language="javascript"  src="/public/javascripts/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" language="javascript"  src="/public/javascripts/knockout-2.1.0.js"></script>
    <script type="text/javascript" language="javascript"  src="/public/javascripts/sammy/sammy-0.7.1.min.js"></script>
    <script type="text/javascript" language="javascript"  src="/public/javascripts/highcharts.js"></script>
</head>
<body>

<div id="header">
    <div id="masthead">
        <div id="logo"><a href="/"><span></span></a></div>
        <div id="autograder"><a href="/"><strong>auto</strong>grader</div></a>
        <div id="status">
            <a href="/mobile/feedback" id="feedback"><span></span>Feedback</a>
            <a href="/admin" id="manage"><span></span>Manage</a>
            <a href="/settings/instructor" id="settings"><span></span>Settings</a>
            <a href="/logout" id="logout"><span></span>Logout</a>
        </div>
    </div>
</div>
    
<ul class="horizontal-list">
    <li><a href="/">Courses</a></li>
</ul>
    
<div id="page-wrapper">
    <div data-bind="template: state"></div>
</div>

<div id = "footer"></div>

<!-- TEMPLATES -->

<script type="text/html" id="courses-template">
    <div id="cards" class="cards" data-bind="foreach: $root.cardViewModel.cards">
        <div class="card">
            <div class="card-header">
                <span class="card-header-icon"></span>
                <h3 class="card-header-name"><a href="#" data-bind="text: name"></a></h3>
            </div>
            <div class="card-separator">
                <span>TUTORS <span data-bind="text: '(' + tutors().length + ')'"></span></span>
            </div>
            <div class="card-tutors">
                <ul data-bind="foreach: tutors">
                    <li><span class="card-status" data-bind="css: { 'card-status-busy': status() === 'Busy' }">
                    </span><span data-bind="text: name"></span>
                    <span class="card-right"><span data-bind="text: hours"></span> hours</span></li>
                </ul>
            </div>
            <div class="card-separator">
                <div class="card-title">
                    <span class="title">QUEUE STATS</span>
                </div>
            </div>
            <div class="card-part card-graph card-body" data-bind="graph: true"></div>
            <div class="card-part card-footer">
                <span class="card-button"><a data-bind="click: function () { $root.cardViewModel.joinRoom($data); }">ENTER</a></span>
                <span class="card-close">Expected Close: 24 hours</span>
            </div>
        </div>
    </div>
</script>

<script type="text/html" id="queue-template">
    <div id="queue"> 
        <div id="sidebar">
            <div class="sidebar-content">
                <div class="sidebar-part sidebar-header">
                    <span class="sidebar-header-icon"></span>
                    <span class="sidebar-header-name" data-bind="text: $root.queueViewModel.name"></span>
                </div>

                <div class="sidebar-part sidebar-separator">
                    <span class="title">TUTORS</span>
                </div>

                <div class="sidebar-part sidebar-list sidebar-tutors">
                    <ul data-bind="foreach: $root.queueViewModel.tutors">
                        <li><span></span><span data-bind="text: name"></span></li>
                    </ul>
                </div>

                <div class="sidebar-part sidebar-separator">
                    <span class="title">QUEUE</span>
                </div>

                <div class="sidebar-list sidebar-queue">
                    <ul data-bind="foreach: $root.queueViewModel.messages">
                        <li data-bind="click: $root.queueViewModel.selectMessage">
                            <span class="sidebar-queue-item title" data-bind="text: student().name"></span>
                            <span class="sidebar-queue-item info" data-bind="text: description"></span>
                        </li>
                    </ul>   
                </div>

            </div>
        </div>

        <div id="main-content">
            <div class="queue-modules" data-bind="foreach: $root.queueViewModel.modules">
                <div data-bind="template: template"></div>
            </div>

            <!-- 
            <div class="section">
                <div class="section-header">
                    <button class="hide-button">Hide</button>
                    <span class="section-header-title">Statistics</span>
                </div>

                <div id="chart-container" style="min-width: 200px; height: 200px; margin: 0 auto"></div>
            </div>

            <div class="section" data-bind="with: $root.queueViewModel.selectedMessage">
                <div class="section-header">
                    <button class="hide-button">Hide</button>
                    <span class="section-header-title">Current Ticket</span>
                </div>
                <div class="section-info">
                    <p data-bind="text: student().name"></p>
                    <p></p> 
                </div>
                <div class="section-content">
                    <p data-bind="text: description"></p>
                </div>
                <div class="section-actions">
                    <button>Accept</button>
                    <button>Defer</button>
                </div>
            </div>
            -->
        </div> 
    </div>
</script>

<script type="text/html" id="info-box-module-template">
    <div data-bind="attr: { class: classes }">
        <div class="info-box-header">
            <span class="info-box-title" data-bind="text: title"></span>
            <span class="info-box-buttons" data-bind="foreach: buttons">
                <span class="button" data-bind="{ click: click, text: text }"></span>
            </span>        
        </div>
        <div class="info-box-content-outer">
            <div class="info-box-content-inner" data-bind="html: content"></div>
        </div>
    </div>
</script>

<!-- SCRIPT -->

<script>

    $(document).ready(function () {

        ko.bindingHandlers.graph = {
            update: function(element, v, a, viewModel) {
                if ("graph" in viewModel) {
                    viewModel.graph(element);
                }
            }
        }

        /*
         * CardModel - used to model the data represented on a card
         *
         * Dependencies:
         *  TutorModel
         */

        var CardModel = function (n, t, s1, s2) {
            var self = this;

            self.name        = ko.observable(n);
            self.tutors      = ko.observableArray(t);
            self.stats       = {
                today: ko.observableArray(s1),
                average: ko.observableArray(s2)
            };

            self.size        = ko.computed(function() {
                return {
                    today: self.stats.today()[self.stats.today().length-1][1],
                    average: self.stats.average()[self.stats.average().length-1][1]
                }
                
            });
            self.wait        = ko.computed(function() {
                return self.size();
            });

            self.time        = ko.observable();
            self.isClosed    = ko.observable(false);
            self.close       = function (expected) { };

            self.graph       = function (element) {
                var series    = [{ name: "Average", data: self.stats.average() }],
                    size      = self.size(),
                    wait      = self.wait(),
                    today     = new Date(),
                    graph;
                today.setHours(8);
                if (!self.isClosed()) {
                    series.push({ name: "Today", data: self.stats.today() });
                }
                Highcharts.setOptions({ global: { useUTC: false } });
                graph = new Highcharts.Chart({
                    chart: {
                        renderTo: element,
                        type: "area",
                        height: 300,
                        spacingBottom: 0,
                        spacingLeft: 0,
                        spacingTop: 0,
                        backgroundColor: "#ebf2d3",
                    },
                    tooltip: {
                        xDateFormat: "%l %P",
                        shared: true
                    },
                    series: series,
                    title: { text: "Size" },
                    xAxis: {
                        title: { text: "Hour" },
                        type: "datetime",
                        tickInterval: 1000 * 3600 * 2,
                        dateTimeLabelFormats: {
                            hour: "%l %P"
                        }

                    },
                    yAxis: { title: { text: "Number of people" } },
                    plotOptions: {
                        area: {
                            pointInterval: 1000 * 3600 * 2,
                            pointStart: today.getTime()
                        }
                    },
                    credits: { enabled: false }
                });
                return true;
            };
        };

        /*
         * TutorModel - used to model the data represented on a tutor status
         */

        var TutorModel = function (n, s, h) {
            var self = this;

            self.name   = n;
            self.status = ko.observable(s); 
            self.hours  = ko.observable(h);
        };

        /*
         * StudentModel
         */
       
        var StudentModel = function (n, s) {
            var self = this; 
            
            self.name = n;
            self.status = ko.observable(s);    
        };

        /*
         * MessageModel
         *
         * 
         */

        var MessageModel = function(s, t, d) {
            var self = this

            self.student = ko.observable(s);
            self.tutor = ko.observable(t);
            self.description = d;
            self.submited = new Date();
            self.answered = ko.observable();
        };

        /*
         * CardViewModel 
         * 
         * Dependencies:
         *  CardModel,
         *  TutorModel
         */

        var CardViewModel = function (queueViewModel) {
            var self  = this,
                savedCards = null;

            self.cards = ko.observableArray([
                new CardModel('CSE 80', [new TutorModel('Herp Derpington', 'Busy', 2)], generateData(), generateData(20)), 
                new CardModel('CSE 132A', [new TutorModel('Vinay V.', 'Available', 3)], generateData(), generateData(20))
            ]);  

            self.joinRoom = function (card) {                
/*                saveCards();
                self.cards(null);*/

                queueViewModel.tutors(card.tutors());
                queueViewModel.name(card.name());

                queueViewModel.messages([
                    new MessageModel(new StudentModel('Derrick McMillen', 'waiting'), card.tutors()[0], 'Lost... no more hope'),
                    new MessageModel(new StudentModel('Chase Murphy', 'waiting'), card.tutors()[0], 'My linked list is unlinked'),
                    new MessageModel(new StudentModel('Anthony Mao', 'waiting'), card.tutors()[0], 'THE MAO EXPERIENCE ENQUEUED!'),
                    new MessageModel(new StudentModel('Ian Foster', 'waiting'), card.tutors()[0], 'I have not slept since 2010'),
                    new MessageModel(new StudentModel('Vinay Ventakesh', 'waiting'), card.tutors()[0], 'Herp derp'),
                    new MessageModel(new StudentModel('Alan A', 'waiting'), card.tutors()[0], 'Herp derp'),
                    new MessageModel(new StudentModel('Joel Jauregui', 'waiting'), card.tutors()[0], 'Herp derp'),
                    new MessageModel(new StudentModel('Calvin Harris', 'waiting'), card.tutors()[0], 'I feel so close to you right now...'),
                    new MessageModel(new StudentModel('Ambuj Punn', 'waiting'), card.tutors()[0], 'Herp derp'),
                    new MessageModel(new StudentModel('Alan A', 'waiting'), card.tutors()[0], 'Herp derp'),
                    new MessageModel(new StudentModel('Alan A', 'waiting'), card.tutors()[0], 'Herp derp'),
                    new MessageModel(new StudentModel('Alan A', 'waiting'), card.tutors()[0], 'Herp derp'),
                    new MessageModel(new StudentModel('Alan A', 'waiting'), card.tutors()[0], 'Herp derp'),
                    new MessageModel(new StudentModel('Alan A', 'waiting'), card.tutors()[0], 'Herp derp'),
                    new MessageModel(new StudentModel('Alan A', 'waiting'), card.tutors()[0], 'Herp derp'),
                    new MessageModel(new StudentModel('Alan A', 'waiting'), card.tutors()[0], 'Herp derp')
                ]); 
            
                app.state(app.states.QUEUE);

                queueViewModel.resizeSidebar();
                queueViewModel.bindShowHideButtons();
            }
        };

        /*
         * Queue View Model
         * 
         * Depends on 
         */

        var QueueViewModel = function() {
            var self = this,
                savedMessages = null;

                /* FIELDS */

                self.name = ko.observable();

                self.tutors = ko.observableArray();
                self.selectedTutor = ko.observable();

                self.messages = ko.observableArray([]);
                self.selectedMessage = ko.observable();

                self.opened = ko.observable();
                self.closed = ko.observable();

                self.modules = ko.observableArray([
                    { template: 'info-box-module-template', title: 'Current Ticket', 
                        classes: 'info-box-base info-box-left info-box-tall info-box-variable-width-module',
                        buttons: [{ text: 'Alert', click: function (e) { alert("You've been alerted."); } }], content: 'ticket goes here' },
                    { template: 'info-box-module-template', title: 'Your Ticket',
                        classes: 'info-box-base info-box-right info-box-small info-box-two-column info-box-variable-width-module', 
                        buttons: [{ text: 'Create', click: function (e) { alert("You've created a ticket."); } }], content: 'ticket meta goes here.' },
                    { template: 'info-box-module-template', title: 'News', 
                        classes: 'info-box-base info-box-right info-box-small info-box-two-column info-box-variable-width-module',
                        buttons: [{ text: 'Refresh', click: function (e) { alert("Getting new content."); } }], content: 'news!' } 
                ]);

                /* METHODS */

                self.selectMessage = function (message) {
                    self.selectedMessage(message);
                    self.bindShowHideButtons();
                };

                self.resizeSidebar = function () {
                    var parts = document.querySelectorAll('.sidebar-part'), 
                        queue = document.querySelector('.sidebar-queue'),
                        horizonalList = document.querySelector('.horizontal-list'),
                        header = document.querySelector('#header'), 
                        height = 0;

                    for (var i = 0; i < parts.length; i++) {
                        var p = parts[i];
                        height += p.scrollHeight;
                    }

                    height += horizonalList.scrollHeight;
                    height += header.scrollHeight; 

                    var tmp = (window.innerHeight - height)
                    queue.style.height = tmp + 'px';
                };

                self.bindShowHideButtons = function () {
                    $('.hide-button').unbind('click');
                    $('.hide-button').click(function (e) {
                        var $this = $(this);

                        if ($this.text() === 'Hide') {
                            $this.parent().siblings().hide();
                            $this.text('Show');
                        }
                        else {
                            $this.parent().siblings().show();
                            $this.text('Hide');
                        }
                    });
                };
        };

        /* This should be getting data from the server, but 
         * for now just generate random data */
        var generateData = function(max){
            max = max || new Date().getHours();
            var output = [],
                i;
            for (i=8; i<=max; i+=2){
                output.push(Math.floor(Math.random()*30));
            }
            return output;
        }

        var AppViewModel = function () {
            var self = this;

            self.states = {
                COURSES: 'courses-template',
                QUEUE: 'queue-template'
            };

            self.state = ko.observable(self.states.COURSES);
            self.selectedQueue = ko.observable(null);

            self.queueViewModel = new QueueViewModel();
            self.cardViewModel = new CardViewModel(self.queueViewModel);
        };

        var app = new AppViewModel();
        ko.applyBindings(app);
    });

</script>
    
</body>
</html>
