<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <title>Courses - Autograder</title>     
    <link rel="stylesheet" type="text/css" href="public/stylesheets/style.css" />
    <link href='http://fonts.googleapis.com/css?family=Droid+Serif|Droid+Sans' rel='stylesheet' type='text/css'>
    
    <meta name="HandheldFriendly" content="true" />
    <meta name="viewport" content="width=device-width,initial-scale:1, maximum-scale=1, user-scalable=0" />
    <meta charset="utf-8" />
    
    <link rel="shortcut icon" type="image/png" href="/public/images/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <link rel="stylesheet" type="text/css" href="queue.css" />
    
    <!--
    <script type="text/javascript" language="javascript"  src="/public/javascripts/jquery-1.7.1.min.js"></script>
    -->

    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="http://jquery-ui.googlecode.com/svn/tags/latest/ui/jquery.effects.core.js"></script>
    <script src="http://jquery-ui.googlecode.com/svn/tags/latest/ui/jquery.effects.slide.js"></script>

    <script type="text/javascript" language="javascript"  src="/public/javascripts/knockout-2.1.0.js"></script>
    <script type="text/javascript" language="javascript"  src="/public/javascripts/sammy/sammy-0.7.1.min.js"></script>
    <script type="text/javascript" language="javascript"  src="/public/javascripts/highcharts.js"></script>
</head>
<body>

<div id="header">
    <div id="masthead">
        <div id="logo"><a href="/"><span></span></a></div>
        <div id="autograder"><a href="/"><strong>auto</strong>grader</div></a>
        <div id="status">
            <a href="#" id="feedback"><span></span>Feedback</a>
            <a href="#" id="checkoff"><span></span>Checkoff</a>
            <a href="#" id="queue"><span></span>Queue</a>
            <a href="#" id="manage"><span></span>Manage</a>
            <a href="#" id="settings"><span></span>Settings</a>
            <a href="#" id="logout"><span></span>Logout</a>
        </div>
    </div>
</div>

<div id="current-student">
    Hello, <span data-bind="text: user.firstName"></span>!
</div>

<!-- <ul class="horizontal-list">
    <li><a href="/">Courses</a></li>
</ul> -->
    
<div id="page-wrapper">
    <div data-bind="template: state"></div>
</div>

<div id="footer"></div>

<!-- TEMPLATES -->

<script type="text/html" id="courses-template">
    <div id="cards" class="cards" data-bind="foreach: $root.cardViewModel.cards">
        <div class="card">
            <div class="card-header" data-bind="click: function() { $root.cardViewModel.joinRoom($data) }">
                <span class="card-header-status"></span>
                <span class="card-header-enter"></span>
                <h3 class="card-header-name"><a data-bind="text: username().course.shortName"></a></h3>
            </div>
            <div class="card-separator">
                <span>TUTORS <span data-bind="text: '(' + tutors().length + ')'"></span></span>
            </div>
            <div class="card-tutors">
                <ul data-bind="foreach: tutors">
                    <li>
                        <span class="card-status" data-bind="css: { 'card-status-busy': status() === 'Busy' }"></span>
                        <span data-bind="text: name"></span>
                        <span class="card-right"><span data-bind="text: hours"></span> hours</span>
                    </li>
                </ul>
            </div>
            <div class="card-separator">
                <div class="card-title">
                    <span class="card-title-part">QUEUE STATS</span>
                    <span class="card-title-part card-right card-graph-type" data-bind="click: function(){ graph($index, 'Wait') }">Wait</span>
                    <span class="card-title-part card-right card-graph-type" data-bind="click: function(){ graph($index, 'Size') }">Size</span>
                </div>
            </div>
            <div class="card-part card-graph card-body" data-bind="event: { load: graph($index, 'Size') }"></div>
            <div class="card-part card-footer">
                <span class="card-close">Expected Close: 24 hours</span>
            </div>
        </div>
    </div>
</script>

<script type="text/html" id="queue-template">
    <div id="queue"> 
        <div id="sidebar">
            <div class="sidebar-content">
                <div class="sidebar-part sidebar-header" data-bind="click: function() { $root.state(States.COURSES); }" >
                    <span class="sidebar-header-icon-leave"></span>
                    <span class="sidebar-header-icon"></span>
                    <span class="sidebar-header-name" data-bind="text: $root.queueViewModel.username().course.shortName"></span>
                    <br class="breaker" />
                </div>

                <div class="sidebar-part sidebar-separator">
                    <span class="card-title-part">TUTORS</span><span class="card-right sidebar-tutors-time-remaining" title="Remaining Time in Lab"></span>
                </div>

                <div class="sidebar-part sidebar-list sidebar-tutors">
                    <ul data-bind="foreach: $root.queueViewModel.tutors">
                    <li>
                        <span class="sidebar-tutors-status" data-bind="css: { 'sidebar-tutors-status-busy': status() === 'Busy' }"></span>
                        <span class="card-right"><span data-bind="text: hours"></span> hours</span>
                        <span class="sidebar-tutors-name" data-bind="text: name"></span><br/>
                        <span class="sidebar-tutors-helping" data-bind="visible: helping()">â†³ Helping: <span data-bind="text: helping() ? helping().fullName() : ''"></span></span>
                    </li>
                </div>

                <div class="sidebar-part sidebar-separator">
                    <span class="title">NOW SERVING</span>
                </div>

                <div class="sidebar-part sidebar-list sidebar-now-serving">
                    <ul data-bind="foreach: $root.queueViewModel.tutors">
                        <li><span></span><span data-bind="text: name"></span></li>
                    </ul>
                </div>

                <div class="sidebar-part sidebar-separator">
                    <span class="title">QUEUE</span>
                </div>

                <div class="sidebar-list sidebar-queue">
                    <ul data-bind="foreach: $root.queueViewModel.tickets">
                        <li data-bind="click: $root.queueViewModel.selectTicket">
                            <span class="sidebar-queue-item-time">:<span data-bind="text: elapsed"></span></span>
                            <span class="sidebar-queue-item title" data-bind="text: ($index() + 1) + '. ' + student().fullName()"></span>
                        </li>
                    </ul>   
                </div>

            </div>
        </div>

        <div id="ticket-drawer">
            <div class="ticket-drawer-content" data-bind="with: $root.queueViewModel.drawerViewModel.currentTicket()">
                <ul class="ticket-drawer-info">
                    <li class="ticket-drawer-info-name" data-bind="text: student().fullName()"></li>
                    <li class="ticket-drawer-info-title" data-bind="text: title"></li>
                    <li class="ticket-drawer-info-description" data-bind="text: description"></li>
                </ul>

                <br class="breaker" />

                <ul class="ticket-drawer-actions">
                    <li><button data-bind="click: accept">Accept</button></li>
                    <li><button data-bind="click: close">Close</button></li>
                    <li><button data-bind="click: notFound">Could Not Find</button></li>
                </ul>

                <br class="breaker" />
            </div>
        </div>
 
        <div id="main-content">
            <div style="width: 55%; float: right;" class="queue-modules" data-bind="foreach: $root.queueViewModel.modules">
                <div data-bind="template: template"></div>
            </div>
        </div> 
    </div>
</script>

<script type="text/html" id="info-box-module-template">
    <div data-bind="attr: { class: classes }">
        <div class="info-box-header">
            <span class="info-box-title" data-bind="text: title"></span>
            <span class="info-box-buttons" data-bind="foreach: buttons">
                <span class="button" data-bind="{ click: click, text: text }"></span>
            </span>        
        </div>
        <div class="info-box-content-outer">
            <div class="info-box-content-inner">
                <div data-bind="template: content_template"></div>
            </div>
        </div>
    </div>
</script>

<script type="text/html" id="current-ticket-module-template">
    <div class="current-ticket-content" data-bind="with: $root.queueViewModel">
        <!-- ko if: acceptedTickets().length === 0 -->
            No tickets currently accepted. Accept a ticket on your left.
        <!-- /ko -->

        <ul class="current-ticket-accepted" data-bind="foreach: acceptedTickets()">
            <li class="current-ticket-line-item" data-bind="click: $root.queueViewModel.selectTicket">
                <span data-bind="text: student().fullName()"></span>
                <span data-bind="text: accepted"></span>
            </li>
        </ul>
    </div>
</script>

<script type="text/html" id="your-ticket-module-tempate">
    <div class="your-ticket-content">

    </div>
</script>

<script type="text/html" id="statistics-module-tempate">
    <div class="statistics-content">

    </div>
</script>

<script type="text/html" id="news-module-template">
    <div class="news-content" >
        
    </div>
</script>

<!-- SCRIPT -->

<script>

    $(document).ready(function () {

        var GraphModel = function(data) {
            var series    = [{ name: "Average", data: data.average }],
                today     = new Date();
            today.setHours(8);
            if (!data.closed) {
                series.push({ name: "Today", data: data.today });
            }
            Highcharts.setOptions({ global: { useUTC: false } });
            var graph = new Highcharts.Chart({
                chart: {
                    renderTo: data.element,
                    type: "area",
                    spacingBottom: 0,
                    spacingLeft: 0,
                    spacingTop: 0,
                    backgroundColor: "#ebf2d3",
                },
                tooltip: {
                    xDateFormat: "%l %P",
                    shared: true
                },
                series: series,
                title: { text: data.title },
                xAxis: {
                    title: { text: "Hour" },
                    type: "datetime",
                    tickInterval: 1000 * 3600 * 2,
                    dateTimeLabelFormats: {
                        hour: "%l %P"
                    }
                },
                yAxis: { title: { text: data.ytitle } },
                legend: {
                    align: "right",
                    verticalAlign: "top",
                    floating: true,
                    layout: "vertical",
                    backgroundColor: "#ebf2d3",
                    y: 10
                },
                plotOptions: {
                    area: {
                        pointInterval: 1000 * 3600 * 2,
                        pointStart: today.getTime()
                    }
                },
                credits: { enabled: false }
            });
        };

        /**
         * CourseModel 
         */

        var CourseModel = function (n, s) {
            var self = this;

            self.name = n;
            self.shortName = s;
        };

        /**
         * CardModel - used to model the data represented on a card
         *
         * Dependencies:
         *  TutorModel
         */

        var CardModel = function (u, t, s1, s2, w1, w2) {
            var self = this;

            self.username    = ko.observable(u);
            self.tutors      = ko.observableArray(t);
            self.sizes       = {
                today: ko.observableArray(s1),
                average: ko.observableArray(s2)
            };
            self.waits       = {
                today: ko.observableArray(w1),
                average: ko.observableArray(w2)
            };

            self.time        = ko.observable();
            self.isClosed    = ko.observable(false);
            self.close       = function (expected) { };

            self.graph       = function (index, type) {
                var options = {
                    element: $("div.card-graph")[index()],
                    title: type,
                    closed: self.isClosed(),
                }
                if (type === "Size") {
                    options.ytitle = "Number of People";
                    options.average = self.sizes.average();
                    options.today = self.sizes.today();
                } else {
                    options.ytitle = "Wait Time (min.)";
                    options.average = self.waits.average();
                    options.today = self.waits.today();
                }
                
                GraphModel(options);
            };
        }

        /*
         * TutorModel - used to model the data represented on a tutor status
         */

        var TutorModel = function (n, s, h) {
            var self = this;

            self.name    = n;
            self.status  = ko.observable(s); 
            self.hours   = ko.observable(h);
            self.helping = ko.observable();
        };

        /*
         * StudentModel
         */
       
        var StudentModel = function (firstName, lastName, s) {
            var self = this; 
            
            self.firstName = firstName;
            self.lastName = lastName;

            self.fullName = ko.computed(function() {
                return self.firstName + " " + self.lastName;
            });

            self.status = ko.observable(s);    
        };

        /**
         * UserModel - designed to match Java server-side model
         */

        var UserModel = function (f, l, p, u) {
            var self = this,
                usernames = u;

            self.firstName  = f;
            self.lastName   = l;
            self.pid        = p;

            // usernames is is readonly
            self.getUsernames = function () {
                return usernames;
            };
        };

        /**
         * UsernameModel - designed to match Java server-side model
         */

        var UsernameModel = function (u, c, r) {
            var self    = this,
                roles   = r;

            self.username   = u;
            self.course     = c; 
            
            // roles is readonly
            self.getRoles   = function () {
                return roles;
            };

            /* METHODS */

            self.isGraderOrInstructor = function () {
                for (var i = 0; i < roles.length; i++) {
                    if (roles[i].name === RoleModel.RoleTypes.GRADER || 
                        roles[i].name === RoleModel.RoleTypes.INSTRUCTOR) {

                        return true;
                    }
                }

                return false;
            };
        };

        /**
         * RoleModel 
         */

        var RoleModel = function (t, s) {
            var self = this;

            self.name   = t;
            self.status = s;
        };

        // Admin & Root omitted due to security issues
        RoleModel.RoleTypes = {
            GRADER:     'Grader',
            INSTRUCTOR: 'Instructor',
            STUDENT:    'Student'
        };

        RoleModel.RoleStatus = {
            NONE:    '', 
            DELETED: 'Deleted',
            PENDING: 'Pending'
        };

        /*
         * TicketModel
         */

        var TicketModel = function (student, tutor, title, description) { 
            var self = this;

            self.student = ko.observable(student);
            self.tutor = ko.observable(tutor);

            tutor.helping(student);

            self.title = title;
            self.description = description;

            self.status = ko.observable(TicketModel.Statuses.PENDING);

            self.accept = function (ticket) {
                self.accepted(new Date());
                app.queueViewModel.acceptedTickets.push(ticket);
            };

            self.close = function (ticket) {
                alert('closing ticket');
            };

            self.notFound = function (ticket) {

            };

            self.submitted = new Date();
            self.accepted = ko.observable();
            self.solved = ko.observable();
            self.elapsed = ko.observable();
        };

        TicketModel.Statuses = {
            ACCEPTED: 'Accepted',
            PENDING: 'Pending',
            SOLVED: 'Solved'
        };

        /*
         * CardViewModel 
         * 
         * Dependencies:
         *  CardModel,
         *  TutorModel
         */

        var CardViewModel = function (user, queueViewModel) {
            var self  = this,
                savedCards = null;

            self.cards = (function() {
                var usernames = user.getUsernames(),
                    cards   = [];

                for (var i = 0; i < usernames.length-1; i++) {
                    cards.push(new CardModel(usernames[i], [ new TutorModel('Herp Derpington', 'Busy', 2), ], generateData(), generateData(20), generateData(30), generateData(30)));
                }

                // Lotsa tutors on this one
                cards.push(new CardModel(usernames[usernames.length-1], [ 
                    new TutorModel('Herp Derpington', 'Busy', 2),
                    new TutorModel('Ierp Eerpington', 'Busy', 2),
                    new TutorModel('Jerp Ferpington', 'Busy', 2),
                    new TutorModel('Kerp Gerpington', 'Busy', 2),
                    new TutorModel('Lerp Herpington', 'Busy', 2),
                    new TutorModel('Merp Ierpington', 'Busy', 2),
                    new TutorModel('Nerp Jerpington', 'Busy', 2),
                    new TutorModel('Oerp Kerpington', 'Busy', 2),
                    new TutorModel('Perp Lerpington', 'Busy', 2),
                ], generateData(), generateData(20), generateData(30), generateData(30)));

                return ko.observableArray(cards);
            })();   

            self.joinRoom = function (card) {                
                queueViewModel.tutors(card.tutors());
                queueViewModel.username(card.username());
                queueViewModel.acceptedTickets([]);

                queueViewModel.tickets([
                    new TicketModel(new StudentModel('Derrick','McMillen', 'waiting'), card.tutors()[0], 'Lost... no more hope', lorem),
                    new TicketModel(new StudentModel('Chase', 'Murphy', 'waiting'), card.tutors()[0], 'My linked list is unlinked', lorem),
                    new TicketModel(new StudentModel('Anthony', 'Mao', 'waiting'), card.tutors()[0], 'THE MAO EXPERIENCE ENQUEUED!', lorem),
                    new TicketModel(new StudentModel('Ian', 'Foster', 'waiting'), card.tutors()[0], 'I have not slept since 2010', lorem),
                    new TicketModel(new StudentModel('Vinay', 'Ventakesh', 'waiting'), card.tutors()[0], 'Herp derp', lorem),
                    new TicketModel(new StudentModel('Joel', 'Jauregui', 'waiting'), card.tutors()[0], 'Herp derp', lorem),
                    new TicketModel(new StudentModel('Calvin', 'Harris', 'waiting'), card.tutors()[0], 'I feel so close to you right now...', lorem),
                    new TicketModel(new StudentModel('Ambuj', 'Punn', 'waiting'), card.tutors()[0], 'Pure thug.', lorem)
                ]); 

                queueViewModel.updateElapsedTime();
            
                app.state(States.QUEUE);

                queueViewModel.resizeSidebar();
                queueViewModel.bindShowHideButtons();
            }
        };

        var DrawerViewModel = function () {
            var self = this;

            self.currentTicket = ko.observable(null);
        };

        /*
         * Queue View Model
         * 
         * Depends on 
         */

        var QueueViewModel = function() {
            var self = this;

                /* FIELDS */
                
                // username instead of name field
                self.username = ko.observable();

                self.tutors = ko.observableArray();
                self.selectedTutor = ko.observable();

                self.tickets = ko.observableArray([]);
                self.selectedTicket = ko.observable();
                self.acceptedTickets = ko.observableArray([]);

                self.selectedTicket.subscribe(function (ticket) {
                    if (ticket) {
                        self.drawerViewModel.currentTicket(ticket);
                    }

                    var ticketDrawer = $('#ticket-drawer');

                    if (!ticketDrawer.hasClass('ticket-drawer-open')) {
                        ticketDrawer.show('slide', { direction: 'left'}, 500);
                        ticketDrawer.addClass('ticket-drawer-open');
                    }
                });

                self.opened = ko.observable();
                self.closed = ko.observable();

                self.modules = ko.observable();

                self.username.subscribe(function() {
                    var modules = [
                        {   template:           'info-box-module-template', 
                            content_template:   'statistics-module-tempate',
                            classes:            'info-box-base info-box-right info-box-small info-box-module',
                            title:              'Statistics',
                            buttons:            [
                                { text: 'Refresh', click: function (e) { alert('Yeah! Refresh!'); } },
                            ]
                        }, 

                        {   template:           'info-box-module-template', 
                            content_template:   'news-module-template',
                            classes:            'info-box-base info-box-right info-box-small info-box-module',
                            title:              'News', 
                            buttons:            [
                                { text: 'Refresh', click: function (e) { alert("Getting new content."); } }
                            ] 
                        } 
                    ];

                    if (self.username() && self.username().isGraderOrInstructor()) {
                        modules.push({   template:           'info-box-module-template', 
                                content_template:   'current-ticket-module-template',
                                classes:            'info-box-base info-box-right info-box-small info-box-module',
                                title:              'Current Ticket',
                                buttons:            [] 
                        });
                    }
                    else {
                        modules.push({   template:           'info-box-module-template', 
                            content_template:   'your-ticket-module-tempate',
                            classes:            'info-box-base info-box-right info-box-small info-box-module',
                            title:              'Your Ticket',
                            buttons:            [
                                { text: 'New Ticket', click: function (e) { alert('Yeah! New ticket!'); } },
                            ]
                        });
                    }

                    self.modules(modules);
                }); 

                self.drawerViewModel = new DrawerViewModel();

                /* METHODS */

                self.updateElapsedTime = function() {
                    var now = Date.now();
                    $.each(self.tickets(), function() {
                        var delta = Math.round((now - this.submitted.getTime()) / (1000 * 60));
                        
                        if (delta.toString().length === 1) {
                            delta = "0" + delta.toString();
                        }
                        
                        this.elapsed(delta);
                    });
                }

                self.selectTicket = function (ticket) {
                    self.selectedTicket(ticket);
                };

                self.resizeSidebar = function () {
                    var parts = document.querySelectorAll('.sidebar-part'), 
                        queue = document.querySelector('.sidebar-queue'),
                        header = document.querySelector('#header'), 
                        drawer = document.querySelector('#ticket-drawer'),
                        height = 8; // still scrolls a bit if set to 0

                    for (var i = 0; i < parts.length; i++) {
                        var p = parts[i];
                        height += p.scrollHeight;
                    }

                    height += header.scrollHeight; 

                    var tmp = (window.innerHeight - height);
                    queue.style.height = tmp + 'px';
                    drawer.style.height = (window.innerHeight - header.scrollHeight) + 'px';
                };

                self.bindShowHideButtons = function () {
                    $('.hide-button').unbind('click');
                    $('.hide-button').click(function (e) {
                        var $this = $(this);

                        if ($this.text() === 'Hide') {
                            $this.parent().siblings().hide();
                            $this.text('Show');
                        }
                        else {
                            $this.parent().siblings().show();
                            $this.text('Hide');
                        }
                    });
                };

                setInterval(self.updateElapsedTime, 60000);
        };

        /* This should be getting data from the server, but 
         * for now just generate random data */
        var generateData = function(max){
            max = max || new Date().getHours();
            var output = [],
                i;
            for (i=8; i<=max; i+=2){
                output.push(Math.floor(Math.random()*30));
            }
            return output;
        }

        var AppViewModel = function () {
            var self = this;

            self.user = new UserModel('Derrick', 'McMillen', 'A01234567', 
                [
                    new UsernameModel('dmcmille', new CourseModel('UNIX Lab', 'CSE 80'), 
                    [new RoleModel(RoleModel.RoleTypes.STUDENT, RoleModel.RoleStatus.NONE)]),
                
                    new UsernameModel('dmcmille', new CourseModel('Databases', 'CSE 132A'), 
                    [new RoleModel(RoleModel.RoleTypes.STUDENT, RoleModel.RoleStatus.NONE)]),

                    new UsernameModel('cs110f1', new CourseModel('Software Engineering', 'CSE 110'), 
                    [new RoleModel(RoleModel.RoleTypes.GRADER, RoleModel.RoleStatus.NONE)]),
                ]);

            self.course = new ko.observable();

            self.state = ko.observable(States.COURSES);

            self.queueViewModel = new QueueViewModel();
            self.cardViewModel = new CardViewModel(self.user, self.queueViewModel);
        };

        States = {
            COURSES: 'courses-template',
            QUEUE: 'queue-template'
        };

        var app = new AppViewModel();
        ko.applyBindings(app);
    });


    lorem = 'Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo.';
    lorem += lorem;

</script>
    
</body>
</html>
