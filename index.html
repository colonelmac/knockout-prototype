<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <title>Courses - Autograder</title>     
    <link rel="stylesheet" type="text/css" href="public/stylesheets/style.css" />
    <link href='http://fonts.googleapis.com/css?family=Droid+Serif|Droid+Sans' rel='stylesheet' type='text/css'>
    
    <meta name="HandheldFriendly" content="true" />
    <meta name="viewport" content="width=device-width,initial-scale:1, maximum-scale=1, user-scalable=0" />
    <meta charset="utf-8" />
    
    <link rel="shortcut icon" type="image/png" href="/public/images/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <link rel="stylesheet" type="text/css" href="queue.css" />
    
    <script type="text/javascript" language="javascript"  src="/public/javascripts/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" language="javascript"  src="/public/javascripts/knockout-2.1.0.js"></script>
    <script type="text/javascript" language="javascript"  src="/public/javascripts/sammy/sammy-0.7.1.min.js"></script>
    <script type="text/javascript" language="javascript"  src="/public/javascripts/highcharts.js"></script>
</head>
<body>

<div id="header">
    <div id="masthead">
        <div id="logo"><a href="/"><span></span></a></div>
        <div id="autograder"><a href="/"><strong>auto</strong>grader</div></a>
        <div id="status">
            <a href="#" id="feedback"><span></span>Feedback</a>
            <a href="#" id="checkoff"><span></span>Checkoff</a>
            <a href="#" id="queue"><span></span>Queue</a>
            <a href="#" id="manage"><span></span>Manage</a>
            <a href="#" id="settings"><span></span>Settings</a>
            <a href="#" id="logout"><span></span>Logout</a>
        </div>
    </div>
</div>
    
<!-- <ul class="horizontal-list">
    <li><a href="/">Courses</a></li>
</ul> -->
    
<div id="page-wrapper">
    <div data-bind="template: state"></div>
</div>

<div id = "footer"></div>

<!-- TEMPLATES -->

<script type="text/html" id="courses-template">
    <div id="cards" class="cards" data-bind="foreach: $root.cardViewModel.cards">
        <div class="card">
            <div class="card-header" data-bind="click: function() { $root.cardViewModel.joinRoom($data) }">
                <span class="card-header-status"></span>
                <span class="card-header-enter"></span>
                <h3 class="card-header-name"><a data-bind="text: name"></a></h3>
            </div>
            <div class="card-separator">
                <span>TUTORS <span data-bind="text: '(' + tutors().length + ')'"></span></span>
            </div>
            <div class="card-tutors">
                <ul data-bind="foreach: tutors">
                    <li>
                        <span class="card-status" data-bind="css: { 'card-status-busy': status() === 'Busy' }"></span>
                        <span data-bind="text: name"></span>
                        <span class="card-right"><span data-bind="text: hours"></span> hours</span>
                    </li>
                </ul>
            </div>
            <div class="card-separator">
                <div class="card-title">
                    <span class="card-title-part">QUEUE STATS</span>
                    <span class="card-title-part card-right card-graph-type" data-bind="click: function(){ graph($index, 'Wait') }">Wait</span>
                    <span class="card-title-part card-right card-graph-type" data-bind="click: function(){ graph($index, 'Size') }">Size</span>
                </div>
            </div>
            <div class="card-part card-graph card-body" data-bind="event: { load: graph($index, 'Size') }"></div>
            <div class="card-part card-footer">
                <span class="card-close">Expected Close: 24 hours</span>
            </div>
        </div>
    </div>
</script>

<script type="text/html" id="queue-template">
    <div id="queue"> 
        <div id="sidebar">
            <div class="sidebar-content">
                <div class="sidebar-part sidebar-header" data-bind="click: function() { $root.state($root.states.COURSES) }" >
                    <span class="sidebar-header-icon-leave"></span>
                    <span class="sidebar-header-icon"></span>
                    <span class="sidebar-header-name" data-bind="text: $root.queueViewModel.name"></span>
                    <br class="breaker" />
                </div>

                <div class="sidebar-part sidebar-separator">
                    <span class="card-title-part">TUTORS</span>
                </div>

                <div class="sidebar-part sidebar-list sidebar-tutors">
                    <ul data-bind="foreach: $root.queueViewModel.tutors">
                    <li>
                        <span class="sidebar-tutors-status" data-bind="css: { 'sidebar-tutors-status-busy': status() === 'Busy' }"></span>
                        <span data-bind="text: name"></span>
                        <span class="card-right"><span data-bind="text: hours"></span> hours</span>
                    </li>
                </div>

                <div class="sidebar-part sidebar-separator">
                    <span class="title">NOW SERVING</span>
                </div>

                <div class="sidebar-part sidebar-list sidebar-now-serving">
                    <ul data-bind="foreach: $root.queueViewModel.tutors">
                        <li><span></span><span data-bind="text: name"></span></li>
                    </ul>
                </div>

                <div class="sidebar-part sidebar-separator">
                    <span class="title">QUEUE</span>
                </div>

                <div class="sidebar-list sidebar-queue">
                    <ul data-bind="foreach: $root.queueViewModel.tickets">
                        <li data-bind="click: $root.queueViewModel.selectTicket">
                            <span class="sidebar-queue-item-time">:<span data-bind="text: elapsed"></span></span>
                            <span class="sidebar-queue-item title" data-bind="text: ($index() + 1) + '. ' + student().firstName + ' ' + student().lastName"></span>
                        </li>
                    </ul>   
                </div>

            </div>
        </div>

        <div id="ticket-drawer">
            <div class="ticket-drawer-content">
                <div>this is the ticker drawer.</div>
                <div>the ticket drawer will slide out when a ticket is clicked on the left</div>
            </div>
        </div>
 
        <div id="main-content">
            <div style="width: 55%; float: right;" class="queue-modules" data-bind="foreach: $root.queueViewModel.modules">
                <div data-bind="template: template"></div>
            </div>
        </div> 
    </div>
</script>

<script type="text/html" id="info-box-module-template">
    <div data-bind="attr: { class: classes }">
        <div class="info-box-header">
            <span class="info-box-title" data-bind="text: title"></span>
            <span class="info-box-buttons" data-bind="foreach: buttons">
                <span class="button" data-bind="{ click: click, text: text }"></span>
            </span>        
        </div>
        <div class="info-box-content-outer">
            <div class="info-box-content-inner">
                <div data-bind="template: content_template"></div>
            </div>
        </div>
    </div>
</script>

<script type="text/html" id="tutor-ticket-module-template">
    <div class="tutor-ticket-content" >
        
    </div>
</script>

<script type="text/html" id="student-ticket-module-template">
    <div class="student-ticket-content" >
        
    </div>
</script>

<script type="text/html" id="ticket-explorer-module-template">
    <div class="ticket-explorer-content" >
        
    </div>
</script>

<script type="text/html" id="news-module-template">
    <div class="news-content" >
        
    </div>
</script>

<!-- SCRIPT -->

<script>

    $(document).ready(function () {

        var GraphModel = function(data) {
            var series    = [{ name: "Average", data: data.average }],
                today     = new Date();
            today.setHours(8);
            if (!data.closed) {
                series.push({ name: "Today", data: data.today });
            }
            Highcharts.setOptions({ global: { useUTC: false } });
            var graph = new Highcharts.Chart({
                chart: {
                    renderTo: data.element,
                    type: "area",
                    height: 300,
                    spacingBottom: 0,
                    spacingLeft: 0,
                    spacingTop: 0,
                    backgroundColor: "#ebf2d3",
                },
                tooltip: {
                    xDateFormat: "%l %P",
                    shared: true
                },
                series: series,
                title: { text: data.title },
                xAxis: {
                    title: { text: "Hour" },
                    type: "datetime",
                    tickInterval: 1000 * 3600 * 2,
                    dateTimeLabelFormats: {
                        hour: "%l %P"
                    }
                },
                yAxis: { title: { text: data.ytitle } },
                legend: {
                    align: "right",
                    verticalAlign: "top",
                    floating: true,
                    layout: "vertical",
                    backgroundColor: "#ebf2d3",
                    y: 10
                },
                plotOptions: {
                    area: {
                        pointInterval: 1000 * 3600 * 2,
                        pointStart: today.getTime()
                    }
                },
                credits: { enabled: false }
            });
        };

        /*
         * CardModel - used to model the data represented on a card
         *
         * Dependencies:
         *  TutorModel
         */

        var CardModel = function (n, t, s1, s2, w1, w2) {
            var self = this;

            self.name        = ko.observable(n);
            self.tutors      = ko.observableArray(t);
            self.sizes       = {
                today: ko.observableArray(s1),
                average: ko.observableArray(s2)
            };
            self.waits       = {
                today: ko.observableArray(w1),
                average: ko.observableArray(w2)
            };

            self.time        = ko.observable();
            self.isClosed    = ko.observable(false);
            self.close       = function (expected) { };

            self.graph       = function (index, type) {
                var options = {
                    element: $("div.card-graph")[index()],
                    title: type,
                    closed: self.isClosed(),
                }
                if (type === "Size") {
                    options.ytitle = "Number of People";
                    options.average = self.sizes.average();
                    options.today = self.sizes.today();
                } else {
                    options.ytitle = "Wait Time (min.)";
                    options.average = self.waits.average();
                    options.today = self.waits.today();
                }
                console.log("Hi: " + type);
                GraphModel(options);
            };
        }

        /*
         * TutorModel - used to model the data represented on a tutor status
         */

        var TutorModel = function (n, s, h) {
            var self = this;

            self.name   = n;
            self.status = ko.observable(s); 
            self.hours  = ko.observable(h);
        };

        /*
         * StudentModel
         */
       
        var StudentModel = function (firstName, lastName, s) {
            var self = this; 
            
            self.firstName = firstName;
            self.lastName = lastName;
            self.status = ko.observable(s);    
        };

        /*
         * TicketModel
         */

        var TicketModel = function (student, tutor, title, description) { 
            var self = this;

            self.student = ko.observable(student);
            self.tutor = ko.observable(tutor);

            self.title = title;
            self.description = description;

            self.submitted = new Date();
            self.answered = ko.observable();

            self.elapsed = ko.observable();
        };

        /*
         * CardViewModel 
         * 
         * Dependencies:
         *  CardModel,
         *  TutorModel
         */

        var CardViewModel = function (queueViewModel) {
            var self  = this,
                savedCards = null;

            self.cards = ko.observableArray([
                new CardModel('CSE 80', [new TutorModel('Herp Derpington', 'Busy', 2)], generateData(), generateData(20), generateData(30), generateData(30)), 
                new CardModel('CSE 132A', [new TutorModel('Vinay V.', 'Available', 3)], generateData(), generateData(20), generateData(30), generateData(30))
            ]);  

            self.joinRoom = function (card) {                
/*                saveCards();
                self.cards(null);*/

                queueViewModel.tutors(card.tutors());
                queueViewModel.name(card.name());

                queueViewModel.tickets([
                    new TicketModel(new StudentModel('Derrick','McMillen', 'waiting'), card.tutors()[0], 'Lost... no more hope', lorem),
                    new TicketModel(new StudentModel('Chase', 'Murphy', 'waiting'), card.tutors()[0], 'My linked list is unlinked', lorem),
                    new TicketModel(new StudentModel('Anthony', 'Mao', 'waiting'), card.tutors()[0], 'THE MAO EXPERIENCE ENQUEUED!', lorem),
                    new TicketModel(new StudentModel('Ian', 'Foster', 'waiting'), card.tutors()[0], 'I have not slept since 2010', lorem),
                    new TicketModel(new StudentModel('Vinay', 'Ventakesh', 'waiting'), card.tutors()[0], 'Herp derp', lorem),
                    new TicketModel(new StudentModel('Joel', 'Jauregui', 'waiting'), card.tutors()[0], 'Herp derp', lorem),
                    new TicketModel(new StudentModel('Calvin', 'Harris', 'waiting'), card.tutors()[0], 'I feel so close to you right now...', lorem),
                    new TicketModel(new StudentModel('Ambuj', 'Punn', 'waiting'), card.tutors()[0], 'Pure thug.', lorem)
                ]); 

                queueViewModel.updateElapsedTime();
            
                app.state(app.states.QUEUE);

                queueViewModel.resizeSidebar();
                queueViewModel.bindShowHideButtons();
            }
        };

        var TicketViewModel = function () {
            var self = this;

            self.currentTicket = ko.observable(null);
        };

        /*
         * Queue View Model
         * 
         * Depends on 
         */

        var QueueViewModel = function() {
            var self = this;

                /* FIELDS */

                self.name = ko.observable();

                self.tutors = ko.observableArray();
                self.selectedTutor = ko.observable();

                self.tickets = ko.observableArray([]);
                self.selectedTicket = ko.observable();

                self.selectedTicket.subscribe(function (ticket) {
                    if (ticket) {
                        self.ticketViewModel.currentTicket(ticket);
                    }
                });


                self.opened = ko.observable();
                self.closed = ko.observable();

                self.modules = ko.observableArray([
                    { template: 'info-box-module-template', content_template: 'tutor-ticket-module-template',
                        title: 'Current Ticket', classes: 'info-box-base info-box-right info-box-module',
                        buttons: [{ text: 'Accept', click: function (e) { alert("You've been accepted."); } },
                                  { text: 'Derp', click: function (e) { alert("You've been derped."); } }] },

                    { template: 'info-box-module-template', title: 'Your Ticket(s)', content_template: 'student-ticket-module-template',
                        classes: 'info-box-base info-box-right info-box-module', 
                        buttons: [{ text: 'Create', click: function (e) { alert("You've created a ticket."); } }] },

                    { template: 'info-box-module-template', content_template: 'ticket-explorer-module-template',
                        title: 'Ticket Explorer', classes: 'info-box-base info-box-right info-box-module', 
                        buttons: [{ text: 'Accept', click: function (e) { alert("You've been accepted."); } },
                                  { text: 'Derp', click: function (e) { alert("You've been derped."); } }] },

                    { template: 'info-box-module-template', title: 'News', content_template: 'news-module-template',
                        classes: 'info-box-base info-box-right info-box-module',
                        buttons: [{ text: 'Refresh', click: function (e) { alert("Getting new content."); } }] } 

                    
                ]);

                self.ticketViewModel = new TicketViewModel();

                /* METHODS */

                self.updateElapsedTime = function() {
                    var now = Date.now();
                    $.each(self.tickets(), function() {
                        var delta = Math.round((now - this.submitted.getTime()) / (1000 * 60));
                        console.log(delta);
                        if (delta.toString().length === 1) {
                            delta = "0" + delta.toString();
                        }
                        this.elapsed(delta);
                    });
                }

                self.selectTicket = function (ticket) {
                    self.selectedTicket(ticket);
                };

                self.resizeSidebar = function () {
                    var parts = document.querySelectorAll('.sidebar-part'), 
                        queue = document.querySelector('.sidebar-queue'),
                        header = document.querySelector('#header'), 
                        drawer = document.querySelector('#ticket-drawer'),
                        height = 0;

                    for (var i = 0; i < parts.length; i++) {
                        var p = parts[i];
                        height += p.scrollHeight;
                    }

                    height += header.scrollHeight; 

                    var tmp = (window.innerHeight - height)
                    queue.style.height = tmp + 'px';
                    drawer.style.height = (window.innerHeight - header.scrollHeight) + 'px';
                };

                self.bindShowHideButtons = function () {
                    $('.hide-button').unbind('click');
                    $('.hide-button').click(function (e) {
                        var $this = $(this);

                        if ($this.text() === 'Hide') {
                            $this.parent().siblings().hide();
                            $this.text('Show');
                        }
                        else {
                            $this.parent().siblings().show();
                            $this.text('Hide');
                        }
                    });
                };

                setInterval(self.updateElapsedTime, 60000);
        };

        /* This should be getting data from the server, but 
         * for now just generate random data */
        var generateData = function(max){
            max = max || new Date().getHours();
            var output = [],
                i;
            for (i=8; i<=max; i+=2){
                output.push(Math.floor(Math.random()*30));
            }
            return output;
        }

        var AppViewModel = function () {
            var self = this;

            self.states = {
                COURSES: 'courses-template',
                QUEUE: 'queue-template'
            };

            self.state = ko.observable(self.states.COURSES);
            self.selectedQueue = ko.observable(null);

            self.queueViewModel = new QueueViewModel();
            self.cardViewModel = new CardViewModel(self.queueViewModel);
        };

        var app = new AppViewModel();
        ko.applyBindings(app);
    });


    lorem = 'Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo.';
    lorem += lorem;

</script>
    
</body>
</html>
